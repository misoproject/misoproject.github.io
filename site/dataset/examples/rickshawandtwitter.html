<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <script type="text/javascript" src="http://use.typekit.com/aow5drr.js"></script>
  <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
  <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
  <!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
  <!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
  <!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
  <head>
    <meta charset='utf-8' />
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible' />
    <meta content='The Miso Project' name='description' />
    <meta content='The Miso Project' name='name' />
    <meta content='width=device-width' name='viewport' />
    <title>The Miso Project :: Dataset :: Examples</title>
    <link href='/stylesheets/screen.css' rel='stylesheet' />
    <link href='/stylesheets/codemirror.css' rel='stylesheet' />
    <link href='/stylesheets/rickshaw/rickshaw.css' rel='stylesheet' />
  </head>
  <body>
    
    <article class='dataset'>
      <section class='topper'>
        <a href='/dataset'>
          <img alt="Dataset" class="logo" src="/images/dataset.png"/>
        </a>
      </section>
      <section class='normal'>
        <h2>Remote Polling Twitter & Rendering With Rickshaw</h2>
        <p>
          This example uses the remote poller to query twitter for a specific url (in this case the term 'javascript'.) The data is then manipulated slightly to keep track of how many different types of punctuations are used.  On the first request, a new derived group by dataset is created that only contains counts for the punctuations available. As new data comes into the original dataset, the group by is automaticaly updated. When the group by is updated it fires off a change event on which we render an updated chart.
        </p>
        <div id='legend' style='float:right;'></div>
        <div id='pieContainer' style='height: 300px; width: 300px;'>
          <div style='padding-top: 30%; width:50%; margin: 0 auto; font-size: 1.5em'>
            Loading Data...
          </div>
        </div>
        <div class="codeblock"><textarea  class="code"  runnable="true" sandbox="" buttons="run,reset,clear" autorun="true">
        // query twitter for tweets containing the term "javascript"
        // and get 100 per page.
        var sequence = 0,
          punctuations = {
          "question" : /\?/g,
          "exclamation" : /\!/g,
          "ellipsis" : /\.\.\./g
        };
        
        var ds = new Miso.Dataset({
        
          // fetch only tweets that come after the last tweet we fetched.
          url : function() {
            var u = "http://search.twitter.com/search.json?q=javascript&rpp=100";
            if (!_.isUndefined(this.since_id)) {
              u = u + "&since_id=" + this.since_id;
            }
            return u + "&callback=";
          },
        
          interval : 1000,
          jsonp : true,
          sync : true,
        
          // we only actually want the number of urls
          extract : function(data) {
            
            // add some properties to the tweets like the number of urls they have
            // and whether they have urls at all.
            _.each(data.results, function(tweet){
              _.each(punctuations, function(regex, name) {
                if (regex.test(tweet.text)) {
                  tweet[name] = tweet.text.match(regex).length / data.results.length;
                } else {
                  tweet[name] = 0;  
                }
        
              });
        
              // save the request sequence id. We are going to group by request.
              tweet.sequence = sequence;
            });
        
            // save the last query id
            this.since_id = data.results[data.results.length-1].id_str;
            return data.results;
          }
        });
        
        var punctuationDataset = null, paintChart, graph, legend;
        
        ds.fetch({
          success : function() {      
            sequence++;
        
            if (punctuationDataset === null) {
              
              // compute a group by that aggregates the tweets into counts for each
              // type of punctuation.
              punctuationDataset = this.groupBy("sequence", _.keys(punctuations));
              
              paintChart = function() {
                $("#pieContainer").children().remove();
                graph = new Rickshaw.Graph({
                  element: $("#pieContainer")[0], 
                  width: 500, 
                  height: 270, 
                  renderer : 'bar',
                  series: prepareData(punctuationDataset, "sequence", _.keys(punctuations))
                });
                   
                graph.render();
              };
        
              // subscribe to changes to the group by.
              punctuationDataset.bind("change", paintChart);
            }
            
            if (sequence >= 3) {
              // render the chart the first time. Subsequent updates will go through
              // the change event.
              paintChart();
        
              // draw legend just once.
              if (_.isUndefined(legend)) {
                legend = new Rickshaw.Graph.Legend( {
                  element: $('#legend')[0],
                  graph: graph
                });  
              }
            }
          }
        });
        
        // because rickshaw expects all the data in x & y formats for every series,
        // we need to transform the data into the following format:
        function prepareData(dataset, x, y) {
        
          if (!_.isArray(y)) {
            y = [y];
          }
          var colors = ['rgba(36,137,64,1)', 'rgba(143,188,43,1)', 'rgba(101,132,47,1)'];
          var series = [];
          _.each(y, function(seriesName, i){
        
            var s = { data : [] ,  color: colors[i], name : seriesName };
        
            dataset.each(function(row) {
              var p = {};
              p.x = row[x];
              p.y = row[seriesName];
              s.data.push(p);
            });
        
            series.push(s);
          });
          return series;
        }</textarea></div>
      </section>
      <nav>
        <ul>
          <li>
            <a href='/dataset'>
              Basics
            </a>
          </li>
          <li>
            <a href='/dataset/examples'>
              Examples
            </a>
            <ul>
            </ul>
          </li>
          <li>
            <a href='/dataset/docs'>
              Docs
            </a>
          </li>
          <li>
            <a href='/dataset/api'>
              API Ref
            </a>
          </li>
        </ul>
      </nav>
    </article>
    <footer>
      <div class='container'>
        <section>
          <h2>
            A joint project between
          </h2>
          <div class='content'>
            <a href='http://www.guardian.co.uk/profile/guardian-interactive-department'>
              <img alt="Guardian" src="/images/guardian.png"/>
            </a>
            <a href='http://www.bocoup.com'>
              <img alt="Bob" src="/images/bob.png"/>
            </a>
          </div>
        </section>
        <section>
          <h2>
            With sponsorship from
          </h2>
          <div class='content'>
            <a href='http://www.guardian.co.uk/development'>
              <img alt="Global dev" src="/images/global-dev.png"/>
            </a>
            <a href='http://www.gatesfoundation.org/'>
              <img alt="Gates" src="/images/gates.png"/>
            </a>
          </div>
        </section>
      </div>
    </footer>
    <script src='/js/jquery.min.js'></script>
    <script src='/js/miso.ds.deps.js'></script>
    <script src='/js/bootstrap/transition.js'></script>
    <script src='/js/bootstrap/collapse.js'></script>
    <script src='/js/codemirror.js'></script>
    <script src='/js/codeblocks.js'></script>
    <script src='/js/nav.js'></script>
    <script src='/js/d3/d3.v2.min.js' type='text/javascript'></script>
    <script src='/js/rickshaw/rickshaw.js' type='text/javascript'></script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-30531498-1']);
      _gaq.push(['_setDomainName', 'misoproject.com']);
      _gaq.push(['_trackPageview']);
    
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
